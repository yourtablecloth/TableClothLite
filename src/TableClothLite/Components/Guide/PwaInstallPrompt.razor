@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (showInstallPrompt)
{
    <div class="pwa-install-prompt" @onclick:stopPropagation="true">
        <div class="install-prompt-content">
            <button class="close-btn" @onclick="DismissPrompt" type="button" aria-label="ë‹«ê¸°">
                âœ•
            </button>
            
            <div class="install-icon">
                <img src="icon-192.png" alt="ì‹íƒë³´ AI" />
            </div>
            
            <h3>ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</h3>
            <p>ì‹íƒë³´ AIë¥¼ í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ì—¬ ë” ë¹ ë¥´ê³  í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ì„¸ìš”!</p>
            
            <div class="install-benefits">
                <div class="benefit-item">
                    <span class="benefit-icon">âš¡</span>
                    <span>ë¹ ë¥¸ ì‹¤í–‰</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">ğŸ“±</span>
                    <span>ì•±ì²˜ëŸ¼ ì‚¬ìš©</span>
                </div>
                <div class="benefit-item">
                    <span class="benefit-icon">ğŸ””</span>
                    <span>ì˜¤í”„ë¼ì¸ ì§€ì›</span>
                </div>
            </div>
            
            <div class="install-actions">
                <button class="btn btn-primary install-btn" @onclick="InstallApp" type="button">
                    ì§€ê¸ˆ ì„¤ì¹˜í•˜ê¸°
                </button>
                <button class="btn btn-secondary later-btn" @onclick="RemindLater" type="button">
                    ë‚˜ì¤‘ì—
                </button>
            </div>
            
            @if (!string.IsNullOrEmpty(installInstructions))
            {
                <div class="install-instructions">
                    <p>@installInstructions</p>
                </div>
            }
        </div>
    </div>
}

@code {
    private bool showInstallPrompt = false;
    private string installInstructions = string.Empty;
    private DotNetObjectReference<PwaInstallPrompt>? dotNetHelper;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("initPwaInstall", dotNetHelper);
            
            // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ ì—¬ë¶€ í™•ì¸ (7ì¼ì— í•œ ë²ˆ)
            var lastDismissed = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "pwa-install-dismissed");
            if (!string.IsNullOrEmpty(lastDismissed))
            {
                if (long.TryParse(lastDismissed, out var timestamp))
                {
                    var daysSinceDismiss = (DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - timestamp) / (1000 * 60 * 60 * 24);
                    if (daysSinceDismiss < 7)
                    {
                        return; // 7ì¼ì´ ì§€ë‚˜ì§€ ì•Šì•˜ìœ¼ë©´ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    }
                }
            }
            
            // ì´ë¯¸ ì„¤ì¹˜ë˜ì—ˆëŠ”ì§€ í™•ì¸
            var isInstalled = await JSRuntime.InvokeAsync<bool>("isPwaInstalled");
            if (!isInstalled)
            {
                // 3ì´ˆ í›„ì— í”„ë¡¬í”„íŠ¸ í‘œì‹œ
                await Task.Delay(3000);
                await CheckAndShowInstallPrompt();
            }
        }
    }

    private async Task CheckAndShowInstallPrompt()
    {
        var canInstall = await JSRuntime.InvokeAsync<bool>("canShowInstallPrompt");
        if (canInstall)
        {
            showInstallPrompt = true;
            StateHasChanged();
        }
        else
        {
            // í”Œë«í¼ë³„ ì„¤ì¹˜ ì•ˆë‚´ í‘œì‹œ
            installInstructions = await GetPlatformInstallInstructions();
            if (!string.IsNullOrEmpty(installInstructions))
            {
                showInstallPrompt = true;
                StateHasChanged();
            }
        }
    }

    private async Task<string> GetPlatformInstallInstructions()
    {
        var userAgent = await JSRuntime.InvokeAsync<string>("eval", "navigator.userAgent");
        
        if (userAgent.Contains("iPhone") || userAgent.Contains("iPad"))
        {
            return "Safariì—ì„œ ê³µìœ  ë²„íŠ¼(â†—ï¸)ì„ ëˆ„ë¥¸ í›„ 'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
        }
        else if (userAgent.Contains("Android"))
        {
            return "Chrome ë©”ë‰´(â‹®)ì—ì„œ 'í™ˆ í™”ë©´ì— ì¶”ê°€'ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
        }
        else if (userAgent.Contains("Chrome") || userAgent.Contains("Edge"))
        {
            return "ì£¼ì†Œì°½ ì˜¤ë¥¸ìª½ì˜ ì„¤ì¹˜ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì„¸ìš”.";
        }
        
        return string.Empty;
    }

    [JSInvokable]
    public async Task ShowInstallPrompt()
    {
        showInstallPrompt = true;
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task InstallApp()
    {
        var installed = await JSRuntime.InvokeAsync<bool>("installPwa");
        if (installed)
        {
            showInstallPrompt = false;
            StateHasChanged();
        }
        else
        {
            // ì„¤ì¹˜í•  ìˆ˜ ì—†ëŠ” ê²½ìš° í”Œë«í¼ë³„ ì•ˆë‚´ í‘œì‹œ
            installInstructions = await GetPlatformInstallInstructions();
            StateHasChanged();
        }
    }

    private async Task DismissPrompt()
    {
        showInstallPrompt = false;
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "pwa-install-dismissed", DateTimeOffset.UtcNow.ToUnixTimeMilliseconds().ToString());
        StateHasChanged();
    }

    private async Task RemindLater()
    {
        showInstallPrompt = false;
        await JSRuntime.InvokeVoidAsync("localStorage.setItem", "pwa-install-dismissed", DateTimeOffset.UtcNow.ToUnixTimeMilliseconds().ToString());
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        if (dotNetHelper != null)
        {
            await JSRuntime.InvokeVoidAsync("disposePwaInstall");
            dotNetHelper.Dispose();
        }
    }
}

<style>
    .pwa-install-prompt {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 9999;
        animation: slideUp 0.3s ease-out;
        padding: env(safe-area-inset-bottom, 0);
    }

    @@keyframes slideUp {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .install-prompt-content {
        background: var(--card-bg, white);
        color: var(--primary-text, #2c3e50);
        border-radius: 16px 16px 0 0;
        padding: 24px;
        max-width: 600px;
        margin: 0 auto;
        position: relative;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
    }

    .close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        background: transparent;
        border: none;
        font-size: 24px;
        color: var(--secondary-text, #7f8c8d);
        cursor: pointer;
        padding: 4px 8px;
        line-height: 1;
        transition: color 0.2s;
    }

    .close-btn:hover {
        color: var(--primary-text, #2c3e50);
    }

    .install-icon {
        text-align: center;
        margin-bottom: 16px;
    }

    .install-icon img {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .install-prompt-content h3 {
        margin: 0 0 8px 0;
        text-align: center;
        font-size: 20px;
        font-weight: 600;
    }

    .install-prompt-content > p {
        text-align: center;
        color: var(--secondary-text, #7f8c8d);
        margin: 0 0 20px 0;
        font-size: 14px;
    }

    .install-benefits {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        gap: 12px;
    }

    .benefit-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--secondary-text, #7f8c8d);
    }

    .benefit-icon {
        font-size: 24px;
    }

    .install-actions {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
    }

    .install-actions button {
        flex: 1;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: 500;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .install-btn {
        background: var(--accent-color, #007bff);
        color: white;
    }

    .install-btn:hover {
        background: var(--accent-hover, #0056b3);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    .later-btn {
        background: var(--secondary-bg, #e9ecef);
        color: var(--primary-text, #2c3e50);
    }

    .later-btn:hover {
        background: var(--hover-bg, #dee2e6);
    }

    .install-instructions {
        padding: 12px;
        background: var(--info-bg, #e3f2fd);
        border-radius: 8px;
        text-align: center;
        font-size: 13px;
        color: var(--info-text, #1976d2);
        line-height: 1.5;
    }

    .install-instructions p {
        margin: 0;
    }

    @@media (max-width: 768px) {
        .install-prompt-content {
            padding: 20px 16px;
        }

        .install-benefits {
            gap: 8px;
        }

        .benefit-item {
            font-size: 12px;
        }

        .benefit-icon {
            font-size: 20px;
        }

        .install-actions button {
            font-size: 14px;
            padding: 10px 16px;
        }
    }

    /* ë‹¤í¬ í…Œë§ˆ ì§€ì› */
    .dark-theme .install-prompt-content {
        background: var(--card-bg, #1e1e1e);
        color: var(--primary-text, #e0e0e0);
    }

    .dark-theme .install-instructions {
        background: var(--info-bg, #1a237e);
        color: var(--info-text, #90caf9);
    }
</style>
