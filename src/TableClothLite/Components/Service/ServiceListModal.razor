@inject SandboxViewModel Model
@inject IJSRuntime JSRuntime

<FluentDialogHeader ShowDismiss="true">
    <FluentStack VerticalAlignment="VerticalAlignment.Center">
        <FluentIcon Value="@(new Icons.Regular.Size24.Apps())" />
        <FluentLabel Typo="Typography.PaneHeader">
            식탁보 라이트 서비스 목록
        </FluentLabel>
    </FluentStack>
</FluentDialogHeader>

<FluentDialogBody Style="max-height: 70vh; overflow-y: auto;">
    <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
        <div style="padding-bottom: 16px; border-bottom: 1px solid var(--neutral-stroke-divider-rest);">
            <p style="margin: 0; color: var(--neutral-foreground-rest); font-size: 14px;">
                설치하지 않고 사용하는 식탁보를 경험해보세요. Windows Sandbox만 설치되어있으면 인터넷 뱅킹 환경을 곧바로 격리된 경량 가상 PC에서 분리해서 실행할 수 있습니다.
            </p>
            <p style="margin: 8px 0 0 0; color: var(--accent-foreground-rest); font-size: 13px; font-weight: 600;">
                ?? Windows Sandbox가 반드시 설치되어 있어야 합니다. 
                <FluentAnchor Href="https://yourtablecloth.app/howto_install_sandbox" Target="_blank" Appearance="Appearance.Lightweight">
                    설치 방법 보기
                </FluentAnchor>
            </p>
        </div>

        <!-- 검색 영역 -->
        <div style="position: sticky; top: 0; background: var(--fill-color); z-index: 10; padding: 8px 0;">
            <FluentSearch @bind-Value="SearchText" 
                         Placeholder="서비스 이름이나 카테고리로 검색..."
                         Style="width: 100%;"
                         Autofocus="true">
                <FluentIcon Value="@(new Icons.Regular.Size16.Search())" Slot="start" />
                @if (!string.IsNullOrWhiteSpace(SearchText))
                {
                    <FluentButton Appearance="Appearance.Stealth" 
                                 OnClick="ClearSearch" 
                                 Style="padding: 4px;"
                                 Slot="end"
                                 Title="검색어 지우기">
                        <FluentIcon Value="@(new Icons.Regular.Size16.Dismiss())" />
                    </FluentButton>
                }
            </FluentSearch>
            
            @if (!string.IsNullOrWhiteSpace(SearchText))
            {
                <div style="margin-top: 8px; font-size: 12px; color: var(--neutral-foreground-rest);">
                    @{
                        var totalFilteredServices = FilteredServiceGroup.SelectMany(g => g).Count();
                    }
                    "@SearchText" 검색 결과: @(totalFilteredServices)개 서비스
                </div>
            }
        </div>

        @if (FilteredServiceGroup.Any())
        {
            @foreach (var eachGroup in FilteredServiceGroup)
            {
                <div>
                    <FluentLabel Typo="Typography.Subject" Style="margin-bottom: 12px; display: block; color: var(--accent-foreground-rest);">
                        @Model.DisplayCategoryName(eachGroup.Key)
                        <span style="font-size: 12px; font-weight: normal; color: var(--neutral-foreground-rest);">
                            (@eachGroup.Count()개)
                        </span>
                    </FluentLabel>
                    
                    <FluentGrid Justify="JustifyContent.FlexStart" Spacing="2" AdaptiveRendering="true">
                        @foreach (var eachService in eachGroup)
                        {
                            <FluentGridItem xs="6" sm="4" md="3">
                                <FluentCard class="service-card" 
                                           Style="height: 140px; cursor: pointer; transition: all 0.2s ease;" 
                                           @onclick="() => LaunchServiceAsync(eachService)"
                                           @onmouseenter="() => OnCardHover(true)"
                                           @onmouseleave="() => OnCardHover(false)">
                                    <FluentStack Orientation="Orientation.Vertical" VerticalAlignment="VerticalAlignment.Center" HorizontalAlignment="HorizontalAlignment.Center" VerticalGap="8">
                                        <FluentIcon Value="@(Icon.FromImageUrl(Model.CalculateAbsoluteUrl(eachService.ImageRelativePath)))" 
                                                   class="service-card-icon"
                                                   Style="width: 32px; height: 32px;" />
                                        <FluentLabel Style="text-align: center; font-size: 13px; line-height: 1.2; font-weight: 500;">
                                            @if (!string.IsNullOrWhiteSpace(SearchText) && 
                                                 eachService.DisplayName.ToLowerInvariant().Contains(SearchText.ToLowerInvariant()))
                                            {
                                                @(HighlightSearchText(eachService.DisplayName, SearchText))
                                            }
                                            else
                                            {
                                                @eachService.DisplayName
                                            }
                                        </FluentLabel>
                                        <FluentIcon Value="@(new Icons.Regular.Size16.Play())" 
                                                   Style="color: var(--accent-foreground-rest); margin-top: 4px;" />
                                    </FluentStack>
                                </FluentCard>
                            </FluentGridItem>
                        }
                    </FluentGrid>
                </div>
            }
        }
        else if (ServiceGroup.Any() && !string.IsNullOrWhiteSpace(SearchText))
        {
            <!-- 검색 결과가 없을 때 -->
            <FluentStack Orientation="Orientation.Vertical" VerticalAlignment="VerticalAlignment.Center" HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 40px;">
                <FluentIcon Value="@(new Icons.Regular.Size48.Search())" Style="color: var(--neutral-foreground-rest); margin-bottom: 16px;" />
                <FluentLabel Typo="Typography.Subject" Style="color: var(--neutral-foreground-rest); text-align: center;">
                    "@SearchText"에 대한 검색 결과가 없습니다
                </FluentLabel>
                <FluentLabel Style="color: var(--neutral-foreground-rest); text-align: center; margin-top: 8px; font-size: 14px;">
                    다른 검색어를 시도해보세요
                </FluentLabel>
                <FluentButton Appearance="Appearance.Lightweight" OnClick="ClearSearch" Style="margin-top: 16px;">
                    <FluentIcon Value="@(new Icons.Regular.Size16.Dismiss())" Slot="start" />
                    검색어 지우기
                </FluentButton>
            </FluentStack>
        }
        else if (!ServiceGroup.Any())
        {
            <FluentStack Orientation="Orientation.Vertical" VerticalAlignment="VerticalAlignment.Center" HorizontalAlignment="HorizontalAlignment.Center" Style="padding: 40px;">
                <FluentProgressRing Style="width: 32px; height: 32px;" />
                <FluentLabel Style="margin-top: 16px; color: var(--neutral-foreground-rest);">
                    서비스 목록을 불러오는 중...
                </FluentLabel>
            </FluentStack>
        }
    </FluentStack>
</FluentDialogBody>

<FluentDialogFooter>
    <FluentButton Appearance="Appearance.Accent" OnClick="@CloseAsync">
        닫기
    </FluentButton>
</FluentDialogFooter>

<style>
    .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    .service-card-icon {
        transition: transform 0.2s ease;
    }
    
    .service-card:hover .service-card-icon {
        transform: scale(1.1);
    }

    .search-highlight {
        background-color: var(--accent-fill-rest);
        color: var(--accent-foreground-rest);
        font-weight: 600;
        padding: 2px 4px;
        border-radius: 2px;
    }
</style>

@code {
    private MarkupString HighlightSearchText(string text, string searchText)
    {
        if (string.IsNullOrWhiteSpace(searchText) || string.IsNullOrWhiteSpace(text))
            return new MarkupString(text);

        var index = text.ToLowerInvariant().IndexOf(searchText.ToLowerInvariant());
        if (index == -1)
            return new MarkupString(text);

        var before = text.Substring(0, index);
        var match = text.Substring(index, searchText.Length);
        var after = text.Substring(index + searchText.Length);

        var highlightedText = $"{before}<span class=\"search-highlight\">{match}</span>{after}";
        return new MarkupString(highlightedText);
    }
}