@using TableClothLite.Services
@using TableClothLite.Shared.Models

<div class="model-indicator @(HasApiKey ? "" : "disabled")" @onclick="OnModelClick" title="@(HasApiKey ? "í´ë¦­í•˜ì—¬ AI ëª¨ë¸ ì„¤ì • ë³€ê²½" : "ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥")">
    <span class="model-icon">ğŸ¤–</span>
    <span class="model-name">@GetModelDisplayName()</span>
    @if (HasApiKey)
    {
        <span class="settings-icon">âš™ï¸</span>
    }
    else
    {
        <span class="lock-icon">ğŸ”’</span>
    }
</div>

<style>
    .model-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        margin: 4px 0;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 12px;
        user-select: none;
        color: #6c757d;
        min-height: 24px;
    }

    .model-indicator:hover:not(.disabled) {
        background: #e9ecef;
        border-color: #007bff;
        color: #007bff;
    }

    .model-indicator.disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: #f8f9fa;
    }

    .model-icon {
        font-size: 14px;
        flex-shrink: 0;
    }

    .model-name {
        font-weight: 500;
        color: inherit;
        line-height: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .settings-icon, .lock-icon {
        font-size: 12px;
        color: inherit;
        flex-shrink: 0;
        opacity: 0.7;
    }

    .model-indicator:hover:not(.disabled) .settings-icon,
    .model-indicator:hover:not(.disabled) .lock-icon {
        opacity: 1;
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @@media (max-width: 480px) {
        .model-indicator {
            font-size: 11px;
            padding: 3px 6px;
            gap: 4px;
            min-height: 20px;
        }

        .model-icon {
            font-size: 12px;
        }

        .settings-icon, .lock-icon {
            font-size: 10px;
        }
    }
</style>

@code {
    [Parameter] public bool HasApiKey { get; set; }
    [Parameter] public EventCallback OnOpenSettings { get; set; }
    [Parameter] public EventCallback OnLogin { get; set; }

    [Inject] private ConfigService ConfigService { get; set; } = default!;

    private SandboxConfig? _currentConfig;

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentConfig();
    }

    protected override async Task OnParametersSetAsync()
    {
        // API í‚¤ ìƒíƒœê°€ ë³€ê²½ë˜ë©´ ì„¤ì • ë‹¤ì‹œ ë¡œë“œ
        if (HasApiKey && _currentConfig is null)
        {
            await LoadCurrentConfig();
        }
    }

    private async Task LoadCurrentConfig()
    {
        try
        {
            _currentConfig = await ConfigService.LoadAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ëª¨ë¸ ì„¤ì • ë¡œë“œ ì¤‘ ì˜¤ë¥˜: {ex.Message}");
            // ê¸°ë³¸ê°’ ì‚¬ìš©
            _currentConfig = new SandboxConfig();
        }
    }

    private string GetModelDisplayName()
    {
        if (!HasApiKey)
        {
            return "AI ëª¨ë¸";
        }

        if (_currentConfig is null)
        {
            return "ë¡œë”©ì¤‘...";
        }

        // ëª¨ë¸ ì´ë¦„ì„ ì‚¬ìš©ì ì¹œí™”ì ìœ¼ë¡œ ë³€í™˜ (ë” ì§§ê²Œ)
        return _currentConfig.OpenRouterModel;
    }

    private async Task OnModelClick()
    {
        if (!HasApiKey)
        {
            await OnLogin.InvokeAsync();
        }
        else
        {
            await OnOpenSettings.InvokeAsync();
        }
    }

    // ì™¸ë¶€ì—ì„œ ì„¤ì • ë³€ê²½ í›„ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œ
    public async Task RefreshConfig()
    {
        await LoadCurrentConfig();
    }
}