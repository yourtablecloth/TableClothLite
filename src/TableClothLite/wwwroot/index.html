<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>식탁보 AI</title>
    <base href="/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <!-- TODO: MSBuild로 이전 검토 -->
    <link href="https://yourtablecloth.app/TableClothCatalog/Catalog.xml" rel="prefetch" />
    <link href="TableClothLite.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    <script src="_content/TG.Blazor.IndexedDB/indexedDb.Blazor.js"></script>
    
    <!-- HTML만 캐시 방지 - 리소스는 조건부 캐시 허용 -->
    <meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <!-- Start Single Page Apps for GitHub Pages -->
    <script type="text/javascript">
      // Single Page Apps for GitHub Pages
      // https://github.com/rafrex/spa-github-pages
      // Copyright (c) 2016 Rafael Pedicini, licensed under the MIT License
      // ----------------------------------------------------------------------
      // This script checks to see if a redirect is present in the query string
      // and converts it back into the correct url and adds it to the
      // browser's history using window.history.replaceState(...),
      // which won't cause the browser to attempt to load the new url.
      // When the single page app is loaded further down in this file,
      // the correct url will be waiting in the browser's history for
      // the single page app to route accordingly.
      (function(l) {
        if (l.search) {
          var q = {};
          l.search.slice(1).split('&').forEach(function(v) {
            var a = v.split('=');
            q[a[0]] = a.slice(1).join('=').replace(/~and~/g, '&');
          });
          if (q.p !== undefined) {
            window.history.replaceState(null, null,
              l.pathname.slice(0, -1) + (q.p || '') +
              (q.q ? ('?' + q.q) : '') +
              l.hash
            );
          }
        }
      }(window.location))
    </script>

    <div id="blazor-error-ui">
        알 수 없는 오류가 발생했습니다.
        <a href="." class="reload">새로 고침</a>
        <span class="dismiss">&#x1F5D9;</span>
    </div>

    <!-- app.js를 먼저 로드 -->
    <script src="js/app.js" type="text/javascript"></script>

    <!-- 스마트 캐시 관리 스크립트 -->
    <script>
        // 스마트 캐시 무효화 - 변경된 리소스만 갱신
        (function() {
            const buildVersion = '2024.1.0'; // GitHub Actions에서 자동 업데이트
            
            // 리소스 해시 체크를 위한 함수
            async function getResourceHash(url) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    return response.headers.get('etag') || response.headers.get('last-modified') || '';
                } catch {
                    return '';
                }
            }
            
            // 캐시된 리소스 해시 저장/조회
            function getCachedHash(url) {
                return localStorage.getItem(`hash_${url}`) || '';
            }
            
            function setCachedHash(url, hash) {
                localStorage.setItem(`hash_${url}`, hash);
            }
            
            // 조건부 캐시 버스터 - 변경된 리소스만
            async function addSmartCacheBuster(element, attribute) {
                const originalUrl = element.getAttribute(attribute);
                if (!originalUrl || originalUrl.startsWith('http') || originalUrl.includes('?')) {
                    return;
                }
                
                const currentHash = await getResourceHash(originalUrl);
                const cachedHash = getCachedHash(originalUrl);
                
                // 해시가 다르거나 처음 로드시에만 버전 파라미터 추가
                if (!cachedHash || currentHash !== cachedHash) {
                    const separator = originalUrl.includes('?') ? '&' : '?';
                    element.setAttribute(attribute, originalUrl + separator + 'v=' + buildVersion);
                    
                    if (currentHash) {
                        setCachedHash(originalUrl, currentHash);
                    }
                    
                    console.log(`캐시 갱신: ${originalUrl}`);
                } else {
                    console.log(`캐시 유지: ${originalUrl}`);
                }
            }
            
            // DOM 로드 후 스마트 캐시 적용
            document.addEventListener('DOMContentLoaded', async function() {
                const promises = [];
                
                // CSS 파일들 체크
                document.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
                    if (!link.href.startsWith('http')) {
                        promises.push(addSmartCacheBuster(link, 'href'));
                    }
                });
                
                // JavaScript 파일들 체크
                document.querySelectorAll('script[src]').forEach(script => {
                    if (!script.src.startsWith('http') && !script.src.includes('_framework/blazor.webassembly.js')) {
                        promises.push(addSmartCacheBuster(script, 'src'));
                    }
                });
                
                await Promise.all(promises);
            });
            
            // 버전 체크 - 앱 전체 버전만 확인
            let lastVersionCheck = Date.now();
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && Date.now() - lastVersionCheck > 600000) { // 10분마다 체크로 빈도 줄임
                    lastVersionCheck = Date.now();
                    checkForUpdates();
                }
            });
            
            // 앱 버전 업데이트 확인
            async function checkForUpdates() {
                try {
                    const response = await fetch('/version.json?t=' + new Date().getTime(), { 
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        const serverInfo = await response.json();
                        const localVersion = localStorage.getItem('app-version');
                        
                        if (localVersion && serverInfo.version && localVersion !== serverInfo.version) {
                            // Blazor 컴포넌트의 OnNewVersionDetected 호출 (포커스 빼앗김 없음)
                            if (window.DotNet && window.dotNetHelper) {
                                window.dotNetHelper.invokeMethodAsync('OnNewVersionDetected', JSON.stringify(serverInfo));
                            } else {
                                // Blazor가 로드되지 않은 경우만 조용한 콘솔 로그
                                console.log('새 버전 감지됨:', serverInfo.version);
                            }
                        }
                        
                        if (serverInfo.version) {
                            localStorage.setItem('app-version', serverInfo.version);
                        }
                    }
                } catch (error) {
                    console.log('Version check failed:', error);
                }
            }
            
            // confirm 제거 - Blazor 컴포넌트에서 처리하도록 변경
            function showUpdateNotification(newVersion) {
                // 더 이상 confirm 사용하지 않음
                console.log('업데이트 알림을 Blazor 컴포넌트로 전달:', newVersion);
            }
            
            // 스마트 새로고침 - 선택적 캐시 클리어
            function smartRefresh() {
                // Service Worker 업데이트
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(function(registrations) {
                        for(let registration of registrations) {
                            registration.update();
                        }
                    });
                }
                
                // 앱 버전만 클리어 (리소스 해시는 유지)
                localStorage.removeItem('app-version');
                
                // 부드러운 새로고침
                window.location.reload();
            }
            
            // 전역 함수로 노출
            window.forceRefresh = smartRefresh;
            window.checkForUpdates = checkForUpdates;
        })();
    </script>

    <script src="_framework/blazor.webassembly.js"></script>
    <script>
        // Service Worker 등록 - 포커스 빼앗김 없는 업데이트 처리
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(function(registration) {
                    console.log('ServiceWorker registration successful');
                    
                    // 업데이트 감지
                    registration.addEventListener('updatefound', function() {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', function() {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // 백그라운드에서 조용히 업데이트 - confirm 제거
                                console.log('새 Service Worker가 설치되었습니다.');
                                
                                // Blazor 컴포넌트로 알림 전달 (포커스 빼앗김 없음)
                                if (window.DotNet && window.dotNetHelper) {
                                    const updateInfo = {
                                        type: 'serviceWorker',
                                        message: '앱이 백그라운드에서 업데이트되었습니다.'
                                    };
                                    
                                    // 5초 후 부드러운 알림
                                    setTimeout(() => {
                                        window.dotNetHelper.invokeMethodAsync('OnNewVersionDetected', JSON.stringify(updateInfo));
                                    }, 5000);
                                } else {
                                    // Blazor가 준비되지 않은 경우 조용히 로그만
                                    console.log('Service Worker 업데이트 완료 - Blazor 로드 대기 중');
                                }
                            }
                        });
                    });
                    
                    // 주기적 업데이트 체크 (30분마다)
                    setInterval(() => {
                        registration.update();
                    }, 30 * 60 * 1000);
                })
                .catch(function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
        }
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HBJP4P0EBY"></script>
    <script type="text/javascript">
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-HBJP4P0EBY');
    </script>
</body>

</html></html>